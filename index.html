<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trasformazione ‚Äì Tracker</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#667eea" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Google Font per la citazione -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,500&display=swap" rel="stylesheet">

  <!-- Chart.js + adapter date-fns per asse temporale -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    :root{
      --brand-1:#667eea;
      --brand-2:#764ba2;
      --text:#2b2b2b;
      --muted:#777;
      --card-bg:#fff;
      --bg-grad:linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      --radius-xl:20px;
      --radius-md:12px;
      --shadow:0 10px 30px rgba(0,0,0,.18);
      --quote-bg:#f0f1f4;
      --quote-border:#e3e6ea;
    }

    /* Resetti e fix generali mobile/iOS */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    html,body{overflow-x:hidden} /* evita qualsiasi sporgenza orizzontale */
    body{
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background:var(--bg-grad);
      color:var(--text);
      padding:10px;
    }

    /* Contenitori */
    .container{max-width:720px;margin:0 auto;padding:8px}
    .header{
      background:var(--card-bg);
      border-radius:var(--radius-xl);
      padding:18px 18px 14px;
      margin:8px 0 14px;
      box-shadow:var(--shadow);
    }
    .header-top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px
    }
    .app-title{color:var(--brand-1);font-size:20px;font-weight:800;line-height:1.2}
    .settings-btn{
      display:inline-flex;align-items:center;gap:8px;
      background:#eef0ff;border:1px solid #dfe3ff;color:#3c49b1;
      padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer
    }

    /* Citazione ‚Äì corsivo sobrio in ‚Äúbassorilievo‚Äù */
    .motivation{
      margin:6px 0 10px;
      background:var(--quote-bg);
      border:1px solid var(--quote-border);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.65),
        0 1px 1px rgba(0,0,0,.04);
    }
    .motivation blockquote{
      font-family:"Playfair Display", serif;
      font-style:italic;         /* corsivo ma pi√π sobrio */
      font-weight:500;           /* meno marcato */
      font-size:16.5px;          /* leggermente ridotto */
      line-height:1.35;          /* pi√π compatto e leggibile */
      color:#555;                /* meno contrasto, pi√π elegante */
      letter-spacing:.1px;
    }

    /* Statistiche */
    .target-info{
      display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
      margin-top:10px;padding-top:12px;border-top:1.5px solid #f0f0f0
    }
    .stat{text-align:center}
    .stat-label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.6px}
    .stat-value{font-size:18px;font-weight:800;color:var(--brand-1);margin-top:4px}

    /* Progress bar */
    .progress-bar{width:100%;height:26px;background:#ececff;border-radius:14px;overflow:hidden;margin:12px 0 2px}
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg, var(--brand-1) 0%, var(--brand-2) 100%);
      transition:width .4s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px
    }

    /* Card e form */
    .card{background:var(--card-bg);border-radius:var(--radius-xl);padding:18px;margin:14px 0;box-shadow:var(--shadow); overflow:hidden}
    .card h2{color:var(--brand-1);font-size:18px;margin-bottom:14px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    label{font-weight:600;color:#4a4a4a;font-size:14px}

    /* Fix input iOS (niente sporgenze, no stili nativi troppo invadenti) */
    input[type="number"], input[type="date"]{
      width:100%;
      min-width:0;                 /* evita overflow in grid su iOS */
      display:block;
      appearance:none;
      -webkit-appearance:none;
      padding:12px 12px;
      border:2px solid #e6e6f7;
      border-radius:12px;
      font-size:16px;
      line-height:1.2;
      background:#fafaff;
      transition:border-color .2s, background .2s;
    }
    /* iOS mostra il testo centrato nel datepicker embedded */
    input[type="date"]{ text-align:center }
    /* Quando focus: bordo brand */
    input[type="number"]:focus, input[type="date"]:focus{
      outline:none;border-color:var(--brand-1);background:#fff
    }

    /* Upload foto */
    .photo-upload{
      border:2.5px dashed #e0e0f5;border-radius:12px;padding:18px;text-align:center;cursor:pointer;transition:all .2s;background:#fafaff
    }
    .photo-upload:hover{border-color:var(--brand-1);background:#f4f6ff}
    .photo-upload input{display:none}
    .photo-preview{max-width:100%;max-height:320px;margin-top:10px;border-radius:12px}

    /* Bottoni */
    .btn{
      width:100%;
      display:inline-block;
      padding:14px;
      background:linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:800;cursor:pointer;transition:transform .15s;margin-top:6px
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-secondary{background:linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)}
    .btn-danger{background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)}
    .backup-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .backup-buttons .btn{font-size:14px;padding:12px}

    .success-message{
      background:#2ecc71;color:#fff;padding:14px;border-radius:12px;margin-bottom:12px;text-align:center;font-weight:800;display:none
    }

    /* Storico */
    .history{margin-top:10px}
    .history-item{
      display:grid;grid-template-columns:64px 1fr auto;align-items:center;gap:12px;
      padding:10px;background:#f6f7ff;border-radius:12px;margin-bottom:10px
    }
    .history-item img,.history-item .placeholder{
      width:64px;height:64px;object-fit:cover;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;background:#fff
    }
    .history-date{font-size:13px;color:#8b8b9a}
    .history-weight{font-size:18px;font-weight:800;color:var(--brand-1)}
    .delete-btn{background:#ff4757;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:12px}

    .file-input-label{display:block;padding:10px 14px;background:var(--brand-1);color:#fff;border-radius:10px;cursor:pointer;font-size:14px;text-align:center;margin-top:10px}
    #restoreFile{display:none}

    /* Modal foto */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:1000;align-items:center;justify-content:center}
    .modal img{max-width:92%;max-height:92%;border-radius:12px}

    /* Setup iniziale / Impostazioni */
    .setup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1100}
    .setup-card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:18px;width:min(560px,92vw)}
    .setup-title{font-size:18px;color:var(--brand-1);font-weight:800;margin-bottom:10px}
    .setup-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .setup-actions{display:flex;gap:10px;margin-top:10px}
    .setup-note{font-size:12px;color:#666;margin-top:6px}

    /* Mobile */
    @media (max-width: 430px){
      body{padding:10px}
      .container{padding:6px}
      .form-grid{grid-template-columns:1fr}
      .setup-grid{grid-template-columns:1fr}
      .history-item{grid-template-columns:56px 1fr auto}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-message" id="successMessage">‚úÖ Dati salvati con successo!</div>

    <div class="header">
      <div class="header-top">
        <div class="app-title" id="appTitle">üéØ Obiettivo</div>
        <button class="settings-btn" type="button" onclick="openSettings()">‚öôÔ∏è Impostazioni</button>
      </div>

      <!-- Citazione motivazionale (cambia ogni giorno) -->
      <div class="motivation" id="motivationBox" aria-live="polite">
        <blockquote id="motivationQuote">...</blockquote>
      </div>

      <div class="target-info">
        <div class="stat">
          <div class="stat-label">Giorni rimanenti</div>
          <div class="stat-value" id="daysLeft">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Persi finora</div>
          <div class="stat-value" id="totalLost">0 kg</div>
        </div>
        <div class="stat">
          <div class="stat-label">Media settimana</div>
          <div class="stat-value" id="weeklyAvg">- kg</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width:0%">0%</div>
      </div>
    </div>

    <div class="card">
      <h2>üìà Andamento peso</h2>
      <div style="height:260px">
        <canvas id="weightChart" aria-label="Grafico andamento peso" role="img"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>üìù Inserisci peso di oggi</h2>
      <form id="weightForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="date">Data</label>
            <input type="date" id="date" required />
          </div>
          <div class="form-group">
            <label for="weight">Peso (kg)</label>
            <input type="number" id="weight" step="0.1" placeholder="Es: 84.2" required />
          </div>
        </div>
        <div class="form-group" style="margin-top:8px">
          <label>üì∏ Foto del giorno</label>
          <div class="photo-upload" id="photoUpload">
            <input type="file" id="photo" accept="image/*" capture="environment" />
            <div>üì∑ Tocca per scattare o caricare foto</div>
            <img id="photoPreview" class="photo-preview" style="display:none" alt="Anteprima foto del giorno" />
          </div>
        </div>
        <button type="submit" class="btn">üí™ Salva Progresso</button>
      </form>
    </div>

    <div class="card">
      <h2>üíæ Backup & Ripristino</h2>
      <p style="color:#666;font-size:14px;margin-bottom:10px">
        Scarica i tuoi dati e salvali su Google Drive, Dropbox o nel telefono.
      </p>
      <div class="backup-buttons">
        <button onclick="downloadBackup()" class="btn btn-secondary">üì• Scarica Backup</button>
        <button onclick="downloadExcel()" class="btn btn-secondary">üìä Esporta Excel</button>
      </div>
      <label for="restoreFile" class="file-input-label">üì§ Carica Backup</label>
      <input type="file" id="restoreFile" accept=".json" onchange="restoreBackup(event)" />
    </div>

    <div class="card">
      <h2>üìä Storico</h2>
      <div id="history" class="history"></div>
    </div>
  </div>

  <!-- MODAL FOTO -->
  <div class="modal" id="imageModal" onclick="closeModal()">
    <img id="modalImage" src="" alt="Foto ingrandita" />
  </div>

  <!-- SETUP INIZIALE / IMPOSTAZIONI -->
  <div class="setup-overlay" id="setupOverlay">
    <div class="setup-card">
      <div class="setup-title">‚öôÔ∏è Configurazione iniziale</div>
      <div class="setup-grid">
        <div class="form-group">
          <label for="setupStartDate">Data inizio</label>
          <input type="date" id="setupStartDate" required />
        </div>
        <div class="form-group">
          <label for="setupEndDate">Data fine</label>
          <input type="date" id="setupEndDate" required />
        </div>
        <div class="form-group">
          <label for="setupStartWeight">Peso iniziale (kg)</label>
          <input type="number" step="0.1" id="setupStartWeight" placeholder="Es: 84.2" required />
        </div>
        <div class="form-group">
          <label for="setupTargetWeight">Peso obiettivo (kg)</label>
          <input type="number" step="0.1" id="setupTargetWeight" placeholder="Es: 75" required />
        </div>
      </div>
      <div class="setup-actions">
        <button class="btn" type="button" onclick="saveSettings()">üíæ Salva</button>
        <button class="btn btn-danger" type="button" onclick="resetSettings()">‚ôªÔ∏è Reset impostazioni</button>
        <button class="btn" type="button" onclick="closeSettings()">Chiudi</button>
      </div>
      <div class="setup-note">I dati restano sul dispositivo. Puoi riaprire questa schermata con ‚ÄúImpostazioni‚Äù.</div>
    </div>
  </div>

  <script>
    /* ====== COSTANTI DB (non cambiare nome/versione per non perdere i dati) ====== */
    const DB_NAME = 'WeightTrackerDB';
    const DB_VERSION = 1;

    /* ====== STATO ====== */
    let db = null;
    let entries = []; // [{date, weight, photo(base64)}]
    let settings = { startDate:null, endDate:null, startWeight:null, targetWeight:null };

    // Chart.js ref
    let chartRef = null;

    // Citazioni del giorno (deterministiche per data)
    const QUOTES = [
      "La costanza batte la motivazione.",
      "Un piccolo passo ogni giorno diventa una lunga strada.",
      "Focalizzati sul processo, il risultato seguir√†.",
      "La disciplina √® scegliere ci√≤ che vuoi di pi√π, non ci√≤ che vuoi adesso.",
      "Se non puoi volare, corri. Se non puoi correre, cammina. Ma non fermarti.",
      "La somma di piccole scelte crea grandi cambiamenti.",
      "Meglio imperfetto che rimandato.",
      "Il corpo segue dove la mente decide di andare.",
      "Oggi √® il giorno migliore per cominciare.",
      "Avanza di un centimetro, ma avanza."
    ];

    /* ====== Helper date ====== */
    const todayISO = () => {
      const d = new Date();
      return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    };

    // Imposta data odierna nel form inserimento + default setup
    (function setDefaultDates(){
      document.getElementById('date').value = todayISO();
      document.getElementById('setupStartDate').value = todayISO();
      const approxEnd = new Date(); approxEnd.setDate(approxEnd.getDate() + 160);
      document.getElementById('setupEndDate').value = new Date(approxEnd.getTime() - approxEnd.getTimezoneOffset()*60000).toISOString().slice(0,10);
    })();

    /* ====== Foto upload ====== */
    document.getElementById('photoUpload').addEventListener('click', () => {
      document.getElementById('photo').click();
    });
    document.getElementById('photo').addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const preview = document.getElementById('photoPreview');
        preview.src = ev.target.result; preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    /* ====== IndexedDB ====== */
    const initDB = () => new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => { db = req.result; resolve(db); };
      req.onupgradeneeded = e => {
        const udb = e.target.result;
        if (!udb.objectStoreNames.contains('entries')) {
          udb.createObjectStore('entries', { keyPath: 'date' });
        }
        if (!udb.objectStoreNames.contains('settings')) {
          udb.createObjectStore('settings', { keyPath: 'key' });
        }
      };
    });

    const getStoreAll = (storeName) => new Promise((resolve, reject) => {
      const tx = db.transaction([storeName],'readonly');
      const st = tx.objectStore(storeName);
      const req = st.getAll();
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
    });

    const getSetting = (key) => new Promise((resolve) => {
      const tx = db.transaction(['settings'],'readonly');
      const st = tx.objectStore('settings');
      const req = st.get(key);
      req.onsuccess = () => resolve(req.result ? req.result.value : null);
      req.onerror = () => resolve(null);
    });

    const setSetting = (key, value) => new Promise((resolve, reject) => {
      const tx = db.transaction(['settings'],'readwrite');
      tx.objectStore('settings').put({ key, value }).onsuccess = () => resolve();
      tx.onerror = () => reject(tx.error);
    });

    const clearStore = (storeName) => new Promise((resolve, reject) => {
      const tx = db.transaction([storeName],'readwrite');
      tx.objectStore(storeName).clear().onsuccess = () => resolve();
      tx.onerror = () => reject(tx.error);
    });

    const saveEntry = entry => new Promise((resolve, reject) => {
      const tx = db.transaction(['entries'],'readwrite');
      tx.objectStore('entries').put(entry).onsuccess = () => resolve();
      tx.onerror = () => reject(tx.error);
    });

    const deleteEntryFromDB = date => new Promise((resolve, reject) => {
      const tx = db.transaction(['entries'],'readwrite');
      tx.objectStore('entries').delete(date).onsuccess = () => resolve();
      tx.onerror = () => reject(tx.error);
    });

    async function loadAll(){
      const e = await getStoreAll('entries');
      entries = e.sort((a,b)=> new Date(b.date) - new Date(a.date));

      settings.startDate   = await getSetting('startDate');
      settings.endDate     = await getSetting('endDate');
      settings.startWeight = await getSetting('startWeight');
      settings.targetWeight= await getSetting('targetWeight');

      if (!settings.startDate || !settings.endDate || !settings.startWeight || !settings.targetWeight){
        openSettings(true); // primo avvio ‚Üí mostra setup
      } else {
        updateUI();
        renderChart();
      }
    }

    /* ====== Form Inserimento ====== */
    document.getElementById('weightForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!settings.startWeight || !settings.targetWeight){
        alert("Completa prima le impostazioni iniziali.");
        openSettings(true);
        return;
      }
      const date = document.getElementById('date').value;
      const weight = parseFloat(document.getElementById('weight').value);
      if (!date || !isFinite(weight)){ alert("Inserisci data e peso validi."); return; }

      const photoInput = document.getElementById('photo');
      const entry = { date, weight, photo:null };

      if (photoInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = async ev => {
          entry.photo = ev.target.result;
          await saveEntry(entry);
          await loadAll(); showSuccess(); resetForm();
        };
        reader.readAsDataURL(photoInput.files[0]);
      } else {
        await saveEntry(entry);
        await loadAll(); showSuccess(); resetForm();
      }
    });

    const showSuccess = () => {
      const m = document.getElementById('successMessage');
      m.style.display='block'; setTimeout(()=> m.style.display='none', 2200);
    };
    const resetForm = () => {
      document.getElementById('weight').value='';
      document.getElementById('photo').value='';
      document.getElementById('photoPreview').style.display='none';
    };

    async function deleteEntry(date){
      if (confirm('Vuoi eliminare questa entry?')){
        await deleteEntryFromDB(date);
        await loadAll();
      }
    }

    /* ====== UI ====== */
    function updateUI(){
      // Titolo con obiettivo
      document.getElementById('appTitle').textContent = `üéØ Obiettivo: ${settings.targetWeight} kg`;

      // Citazione del giorno
      setDailyQuote();

      // Giorni rimanenti
      const end = new Date(settings.endDate);
      const now = new Date();
      const diffDays = Math.ceil((end - now) / (1000*60*60*24));
      document.getElementById('daysLeft').textContent = diffDays>0 ? diffDays : 0;

      // Progress bar e persi finora
      const bar = document.getElementById('progressBar');
      if (entries.length > 0){
        const current = entries[0].weight;
        const lost = (settings.startWeight - current);
        const targetLoss = Math.max(settings.startWeight - settings.targetWeight, 0.0001);
        const progress = Math.min((lost / targetLoss) * 100, 100);
        document.getElementById('totalLost').textContent = `${lost.toFixed(1)} kg`;
        bar.style.width = `${progress.toFixed(1)}%`;
        bar.textContent = `${progress.toFixed(0)}%`;
      } else {
        document.getElementById('totalLost').textContent = '0 kg';
        bar.style.width = '0%'; bar.textContent = '0%';
      }

      // Media settimana (ultimi inserimenti, max 7)
      const weeklyAvgEl = document.getElementById('weeklyAvg');
      if (entries.length >= 7) {
        const last = entries.slice(0,7);
        const sum = last.reduce((a,e)=>a+e.weight,0);
        weeklyAvgEl.textContent = (sum/7).toFixed(1) + ' kg';
      } else if (entries.length > 0){
        const sum = entries.reduce((a,e)=>a+e.weight,0);
        weeklyAvgEl.textContent = (sum/entries.length).toFixed(1) + ' kg';
      } else {
        weeklyAvgEl.textContent = '- kg';
      }

      // Storico
      const historyDiv = document.getElementById('history');
      if (entries.length === 0){
        historyDiv.innerHTML = '<p style="text-align:center;color:#888">Nessun dato ancora. Inizia a tracciare!</p>';
      } else {
        historyDiv.innerHTML = entries.map(entry=>{
          const dateStr = new Date(entry.date).toLocaleDateString('it-IT',{ weekday:'short', day:'numeric', month:'short', year:'numeric' });
          const imgEl = entry.photo
            ? `<img src="${entry.photo}" alt="Foto ${dateStr}" onclick="openModal('${entry.photo}')" />`
            : `<div class="placeholder" onclick="alert('Nessuna foto per questa data')">üì∑</div>`;
          return `
            <div class="history-item">
              ${imgEl}
              <div>
                <div class="history-date">${dateStr}</div>
                <div class="history-weight">${entry.weight} kg</div>
              </div>
              <button class="delete-btn" onclick="deleteEntry('${entry.date}')">üóëÔ∏è</button>
            </div>
          `;
        }).join('');
      }
    }

    function renderChart(){
      const ctx = document.getElementById('weightChart').getContext('2d');
      const asc = [...entries].sort((a,b)=> new Date(a.date) - new Date(b.date));
      const labels = asc.map(e => new Date(e.date));
      const weights = asc.map(e => e.weight);
      const showLabels = labels.length ? labels : [new Date(settings.startDate || todayISO())];
      const showWeights = weights.length ? weights : (settings.startWeight ? [settings.startWeight] : []);

      if (chartRef){ chartRef.destroy(); }
      chartRef = new Chart(ctx, {
        type:'line',
        data:{
          labels: showLabels,
          datasets:[{
            label:'Peso (kg)',
            data: showWeights,
            tension:.3,
            fill:false,
            borderWidth:2,
            pointRadius:3
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ type:'time', time:{ unit:'day' }, ticks:{ autoSkip:true, maxTicksLimit:6 } },
            y:{ beginAtZero:false, ticks:{ precision:1 } }
          },
          plugins:{ legend:{ display:false } }
        }
      });
    }

    // Citazione del giorno (deterministica per data)
    function setDailyQuote(){
      const qEl = document.getElementById('motivationQuote');
      const d = new Date();
      const dayKey = Math.floor(d.getTime() / (1000*60*60*24)); // giorni dal 1970
      const idx = dayKey % QUOTES.length;
      qEl.textContent = QUOTES[idx];
    }

    // Modale foto
    function openModal(src){
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').style.display = 'flex';
    }
    function closeModal(){ document.getElementById('imageModal').style.display = 'none'; }

    // Impostazioni / Setup
    function openSettings(isFirst=false){
      document.getElementById('setupOverlay').style.display='flex';
      if (!isFirst){
        if (settings.startDate)   document.getElementById('setupStartDate').value = settings.startDate;
        if (settings.endDate)     document.getElementById('setupEndDate').value = settings.endDate;
        if (settings.startWeight) document.getElementById('setupStartWeight').value = settings.startWeight;
        if (settings.targetWeight)document.getElementById('setupTargetWeight').value = settings.targetWeight;
      }
    }
    function closeSettings(){ document.getElementById('setupOverlay').style.display='none'; }

    async function saveSettings(){
      const startDate   = document.getElementById('setupStartDate').value;
      const endDate     = document.getElementById('setupEndDate').value;
      const startWeight = parseFloat(document.getElementById('setupStartWeight').value);
      const targetWeight= parseFloat(document.getElementById('setupTargetWeight').value);
      if (!startDate || !endDate || !isFinite(startWeight) || !isFinite(targetWeight)){
        alert("Compila tutti i campi in modo valido."); return;
      }
      await setSetting('startDate', startDate);
      await setSetting('endDate', endDate);
      await setSetting('startWeight', startWeight);
      await setSetting('targetWeight', targetWeight);

      settings = { startDate, endDate, startWeight, targetWeight };
      closeSettings();
      updateUI(); renderChart();
    }

    async function resetSettings(){
      if (!confirm("Questo reimposta le impostazioni iniziali (non elimina lo storico). Continuare?")) return;
      await clearStore('settings');
      settings = { startDate:null, endDate:null, startWeight:null, targetWeight:null };
      openSettings(true);
    }

    // Backup / Restore / Export
    function downloadBackup(){
      const data = { version:1, exportDate:new Date().toISOString(), settings, entries };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `weight-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(url);
      alert('‚úÖ Backup scaricato! Salvalo in un posto sicuro.');
    }

    async function restoreBackup(event){
      const file = event.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try{
          const data = JSON.parse(e.target.result);
          if (!data.entries || !Array.isArray(data.entries)) { alert('‚ùå File di backup non valido!'); return; }
          if (confirm(`Ripristinare ${data.entries.length} entries e impostazioni? I dati attuali verranno sovrascritti.`)){
            await clearStore('entries'); await clearStore('settings');
            if (data.settings){
              const { startDate, endDate, startWeight, targetWeight } = data.settings;
              if (startDate)   await setSetting('startDate', startDate);
              if (endDate)     await setSetting('endDate', endDate);
              if (startWeight) await setSetting('startWeight', startWeight);
              if (targetWeight)await setSetting('targetWeight', targetWeight);
            }
            for (const entry of data.entries){ await saveEntry(entry); }
            await loadAll();
            alert('‚úÖ Backup ripristinato con successo!');
          }
        } catch(err){ alert('‚ùå Errore nel ripristino: '+err.message); }
      };
      reader.readAsText(file);
    }

    function downloadExcel(){
      let csv = 'Data,Peso (kg),Differenza dal precedente\n';
      for (let i = entries.length - 1; i >= 0; i--){
        const e = entries[i];
        const diff = i < entries.length - 1 ? (e.weight - entries[i+1].weight).toFixed(1) : '0';
        csv += `${e.date},${e.weight},${diff}\n`;
      }
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `weight-tracker-${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
      alert('‚úÖ File Excel scaricato!');
    }

    // Service Worker PWA
    if ('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW registration failed:', err));
      });
    }

    // Boot
    initDB()
      .then(loadAll)
      .catch(err => {
        console.error('Errore inizializzazione DB:', err);
        alert("Errore nell'inizializzazione. Ricarica la pagina.");
      });
  </script>
</body>
</html>
